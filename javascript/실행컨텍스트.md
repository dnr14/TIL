# 실행컨텍스트

### 소스코드의 타입

소스코가 평가되는 위치에 따라 실행 되는 컨텍스트가 구분이 된다.

1. 전역 실행 컨텍스트
2. 함수 실행 컨텍스트
3. eval 실행 컨텍스트
4. 모듈 실행 컨텍스트

### 소스코드 평가와 실행

자바스크립트 엔진은 `소스코드의 평가`,`소스코드의 실행` 2가지 과정으로 나눈다.

소스코드 평가 과정

1. 실행 컨텍스트 생성한다.
2. 변수, 함수 선언문만 먼저 실행 후 렉시컬 환경의 환경 레코드에 키로 관리한다.

소스코드 실행

1. 런타임이 시작되면 선언문을 제외한 소스코드를 순차적으로 실행한다.
2. 변수,함수를 만나면 렉시컬 환경의 환경 레코드에 필요정보가 있는지 검색 합니다.
3. 변수의 값 변경이 있다면 실행 컨텍스트의 렉시컬 환경의 환경 레코드를 갱신한다.

---

```jsx
var x; // 런타임 이전에 환경레코드에 undefined로 할당되어있다.
x = 1; // 실행 컨텍스트의 렉시컬 환경 환경 레코드를 갱신한다.
```

     😃 위에 내용을 간단한 그림으로 표현하면 아래와 같다.

| 실행 컨텍스트 |           |
| ------------- | --------- |
| x             | undefined |
| 소스코드 평가 |           |

| 실행 컨텍스트 |     |
| ------------- | --- |
| x             | 1   |
| 소스코드 실행 |     |

1. `var x`는 소스코드 평가 단계를 먼저 한다. 전역 실행 컨텍스트를 만들고 렉시컬 환경의 환경 레코드에 x 값이 undefined로 할당이 된다.
2. 소스코드 실행(런타임)에서 변수 x를 참조하게 되면 어디 있는지 찾는데 실행 컨텍스트가 관리하는 렉시컬 환경을 찾고 환경 레코드에서 검색을 후 x 가 있다면 값을 갱신한다.

---

### 실행 컨텍스트의 역할

```jsx
const x = 1;
const y = 2;

function foo(a) {
  const x = 10;
  const y = 20;
  console.log(a + x + y);
}

foo(100);

console.log(x + y);
```

실행순서

1. 전역 코드 평가
   1. 전역 실행 컨텍스트가 생성되고 변수 선언문 , 함수 선언문 먼저 실행 후전역 스코프에 등록한다.
2. 전역 코드 실행
   1. 런타임이 시작 시 코드는 순차적으로 실행된다. 변수를 참조하면 렉시컬 환경의 환경 레코드에서 검색을 하고 변경이 있다면 갱신을 한다.
   2. 순차적으로 실행되다가 함수 호출이 발생하면 전역 실행 컨텍스트는 일시 중단을하고 코드 실행 순서를 변경하여 함수 내부로 진입한다.
3. 함수 코드 평가
   1. 함수 실행 컨텍스트가 생성되고 지역 변수 선언문, 함수 선언문을 먼저 평가 후 렉시컬 환경의 환경 레코드에 관리를 한다. 이때 함수의 매개변수, arguments 객체도 렉시컬 환경에서 관리한다.
   2. 이후 this 바인딩을 한다.
4. 함수 코드 실행

   1. 소스 코드를 순차적으로 실행한다. 변수를 참조하거나 함수 호출이 발생하면 전역 실행 컨텍스트와 동일하게 작동한다.
   2. 식별자(console, x, y, a)를 참조하기 위해 지역 렉시컬 환경에서 검색을 하고 없다면 상위 스코프(상위 렉시컬 환경)으로 순차적으로 올라간다.

   <aside>
   💡 스코프는 중첩 관계가 될 수 있다. 스코프는 단방향 링크드 리스트 형태로 스코프 체인을 형성해서 상위 스코프로 식별자를 검색 할 수 있다.

   </aside>

   실행 컨텍스트는 코드 실행 순서와 관리가 필요해서 생성된다.

   > 📜 **요약**
   > 실행 컨텍스트는 식별자(변수, 함수, 클래스 등)를 등록하고 관리하는 스코프와 코드 실행 순서 관리를 구현한 내부 메커니즘으로 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.

   ⭐ 식별자와 스코프는 실행 컨텍스트의 렉시컬 환경이 관리하고 코드의 실행 순서는 실행 컨텍스트 스택으로 관리한다.

   >

   ***

   ### 실행 컨텍스트 스택

   ```jsx
   const x = 1;

   function foo() {
     const y = 2;
     function bar() {
       const z = 3;
       console.log(x + y + z);
     }
     bar();
   }

   foo();
   ```

   실행 컨텍스트는 스택 형태로 코드 순서가 관리 된다. 이것을 실행 컨텍스트 스택이라고 한다.

   ❗ 실행 컨텍스트 스택의 최상위에 존재하는 실행 컨텍스트는 언제나 현재 실행 중인 코드의 실행 컨텍스트다. 이를 실행 중인 실행 컨텍스트라고 부른다.

   스택 순서

   1. 전역 코드의 평가와 실행( 전역 실행 컨텍스트 )
   2. foo함수 코드의 평가와 실행( 함수 실행 컨텍스트 )
   3. bar함수 코드의 평가와 실행( 함수 실행 컨텍스트 )
   4. foo함수 코드 복귀( 함수실행 컨텍스트 )
   5. 전역 코드로 복귀 ( 전역 실행 컨텍스트 )

   <aside>
   💡 위에 실행 컨텍스트 동작 과정을 생각하면서 해석 해보자.

   </aside>

   ***

   ### 렉시컬 환경

   ```jsx
   const x = 1;
   // 전역 실행 컨텍스트
   // 렉시컬 환경의 환경 레코드에 x, foo함수가 등록된다.
   function foo() {
     // 함수 실행 컨텍스트
     // 렉시컬 환경의 환경 레코드에 y가 등록된다.
     const y = 2;
     console.log(x + y);
     // 렉시컬 환경에 등록된 외부 렉시컬 환경 참조 값을 이용해
     // 상위 렉시컬 환경(상위 스코프)로 올라 갈 수 있다.
   }
   ```

   렉시컬 환경은 스코프, 식별자, 식별자에 바인딩된 값, 상위 스코프에 대한 참조(OER)를 관리한다.

   렉시컬 환경에서도 여러개의 객체형태의 스코프(전역, 함수, 블록)를 생성한다. 스코프에 따라 식별자를 구분하고 등록 관리한다.

   ⭐ 렉시컬 스코프는 스코프 저장 역할을하는 것이다.

   | 실행 컨텍스트 | excution context     |
   | ------------- | -------------------- |
   | 렉시컬 환경   | lexical environment  |
   | 변수 환경     | variable environment |

   | 렉시컬 환경           | lexical environment       |
   | --------------------- | ------------------------- |
   | 환경 레코드           | environment record        |
   | 외부 렉시컬 환경 참조 | outer lexical environment |
   | Reference             |

   ### 실행 컨텍스트와 블록 레벨 스코프

   ```jsx
   let x = 1;
   if (true) {
     let x = 10;
     console.log(x); // 10
   }
   console.log(x); // 1
   ```

   let, const는 블록 레벨 스코프이고 var는 함수 레벨 스코프이다.

   전역 실행 컨텍스트 안에 전역 렉시컬 환경과 블록 렉시컬 환경이 생성된다. 블록 레벨 스코프가 만들어진다. 실행 컨텍스트는 1개 혹은 1개 이상 렉시컬 환경을 가질 수 있다.

   ```jsx
   for (let i = 0; i < 5; i++) {
     console.log(i); // 0 1 2 3 4
   }
   ```

   for문도 블록 레벨 스코프이다 이때 let 키워드를 사용하면 반복해사 실행 될 때마다 코드 블록을 위한 새로운 렉시컬 환경이 생성된다.
